var express = require('express');
var router = express.Router();
var multer = require('multer');
const malware = require('../malware');

const multerConfig = {

    storage: multer.diskStorage({
        //Setup where the user's file will go
        destination: function(req, file, next){
            console.log("diskStorage");
            next(null, './files');
        },

        //Then give the file a unique name
        filename: function(req, file, next){
            console.log("fileStorage");
            console.log(file.originalname.split('.'));
            const ext = file.originalname.split('.')[1];
            next(null, 'checker.'+ext);
        }
    })
};


/* GET home page. */
router.get('/', function(req, res, next) {
  res.render('index', { title: 'Express' });
});

router.post('/upload', multer(multerConfig).single('fileUploader'), function (req, res) {
    malware.check_features((err, data) => {
        if(err != null)
            res.json({status: "Error", message: err});
        else
            res.json({status: "Success", data: data});
    });
    // res.json({sucess: true, fileUpload: 'Complete'});
});

router.get('/features', function (req, res, next) {
     res.json({status: "Success", data: ["Machine", "SizeOfOptionalHeader", "Characteristics", "ImageBase", "MajorOperatingSystemVersion", "MajorSubsystemVersion", "Subsystem", "DllCharacteristics", "SizeOfStackReserve", "SectionsMeanEntropy", "SectionsMaxEntropy", "ResourcesMaxEntropy", "VersionInformationSize"]});
});

module.exports = router;
